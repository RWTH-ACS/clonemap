<!--sidebar-->
<div class="sidebar" >
    <div class="nav">
        <div class="nav-item" *ngFor="let id of MASID, index as i" routerLinkActive="is-active" [ngClass]="id === selectedMASID ? 'active' : ''">
            <a class="list-text"  [routerLink]="['/logger', id]" >
                <p > MAS {{ id }}</p>
            </a>
        </div>
    </div>
</div> 

<!--modal for adding agents-->
<ng-template #content let-modal>
    <div class="modal-header">
        <h2 class="modal-title">Add Agent</h2>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
        <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body default-fontsize">
        <div class="d-flex  flex-wrap">
            <div *ngFor="let id of notSelectedID">
                <div class="agent-not-selected"  [ngValue]="id" (click)="onAddID(id)">
                    agent {{id}}
                </div>
            </div>
        </div>       
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary default-fontsize" (click)="onConfirm()">OK</button>
    </div>
</ng-template>


<div class="content-container">
    <div class="notalive" *ngIf="!alive" >
        <h1>Logger is not alive......</h1>
    </div>
    <div *ngIf="alive">
        <ul class="nav nav-tabs justify-content-end">
            <li class="nav-item"  >
                <a class="nav-link" [class.active]="currState==='log'" (click)="onClickLog()" >log</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currState==='logSeries'" (click)="onClickLogSeries()">logSeries</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currState==='statistics'" (click)="onClickStatistics()">statistics</a>
            </li>
            <li class="nav-item" style="padding-right:10rem;">
                <a class="nav-link" [class.active]="currState==='heatmap'" (click)="onClickHeatmap()">heatmap</a>
            </li>
        </ul>
       <!--selection board -->
        <div  class="my-5 d-flex justify-content-center">
            <!--exclusive for statistic condition -->                
            <div *ngIf="currState==='statistics'">
                <mat-form-field appearance="fill" class="mr-4">
                    <mat-label>agent</mat-label>
                    <mat-select (selectionChange)="updateSelectedAgent($event.value)">
                        <mat-option *ngFor="let agent of agentID" [value]="agent">
                        agent {{agent}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="fill" class="mr-4">
                    <mat-label>type
                    </mat-label>
                    <mat-select (selectionChange)="updateSelectedBehType($event.value)">
                        <mat-option *ngFor="let type of behaviorTypes" [value]="type">
                        {{type}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <!--start date --> 
            <mat-form-field appearance="fill" class="example-form-field">
                <mat-label>Start date</mat-label>
                <input matInput 
                    [matDatepicker]="startdatepicker"
                    [(ngModel)]="selectedStartDate"
                >
                <mat-datepicker-toggle matSuffix [for]="startdatepicker"></mat-datepicker-toggle>
                <mat-datepicker #startdatepicker>
                    <mat-datepicker-actions>
                    <button class="btn" mat-button matDatepickerCancel>Cancel</button>
                    <button class="btn btn-primary" mat-raised-button color="primary" matDatepickerApply>OK</button>
                    </mat-datepicker-actions>
                </mat-datepicker>
            </mat-form-field>
            <!--start time --> 
            <mat-form-field  appearance="fill" class="example-form-field mr-4">
                <mat-label>Start time</mat-label>
                <input matInput
                    name="selected_start_time"
                    format="24"
                    [(ngModel)]="selectedStartTime"
                    [ngxMatTimepicker]="pickerA"
                    placeholder="00:00"
                    readonly />
                <mat-icon matSuffix (click)="pickerA.open()">
                    watch_later
                </mat-icon>
            </mat-form-field>
            <ngx-mat-timepicker #pickerA></ngx-mat-timepicker>
            <!--end date -->                        
            <mat-form-field appearance="fill" class="example-form-field">
                <mat-label>End date</mat-label>
                <input matInput 
                    [matDatepicker]="enddatepicker"
                    [(ngModel)]="selectedEndDate"
                    >
                <mat-datepicker-toggle matSuffix [for]="enddatepicker"></mat-datepicker-toggle>
                <mat-datepicker #enddatepicker>
                    <mat-datepicker-actions>
                    <button class="btn" mat-button matDatepickerCancel>Cancel</button>
                    <button class="btn btn-primary" mat-raised-button matDatepickerApply>OK</button>
                    </mat-datepicker-actions>
                </mat-datepicker>
            </mat-form-field>
            <!--end time --> 
            <mat-form-field appearance="fill" class="mr-4">
                <mat-label>End time</mat-label>
                <input matInput
                    name="selected_end_time"
                    format="24"
                    [(ngModel)]="selectedEndTime"
                    [ngxMatTimepicker]="pickerB"
                    placeholder="23:49"
                    readonly />
                <mat-icon matSuffix
                        (click)="pickerB.open()">
                    watch_later
                </mat-icon>
            </mat-form-field>
            <ngx-mat-timepicker #pickerB></ngx-mat-timepicker>
            <!--exclusive for logSeries condition -->  
            <div *ngIf="currState==='logSeries'">
                <mat-form-field appearance="fill">
                    <mat-label>Name</mat-label>
                    <mat-select (selectionChange)="updateSelectedName($event.value)">
                        <mat-option *ngFor="let name of names" [value]="name">
                        {{name}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <!--exclusive for heatmap condition -->
            <div *ngIf="currState==='heatmap'">
                <mat-form-field appearance="fill" class="mr-4" style="width: 20rem;">
                    <mat-label>Automatic partition?</mat-label>
                    <mat-select (selectionChange)="updatePartition($event.value)">
                        <mat-option value="Yes">Yes</mat-option>
                        <mat-option value="No">No</mat-option>
                    </mat-select>
                </mat-form-field>
                
                <mat-form-field appearance="fill" [hidden]="autoPartition" style="width: 10rem;">
                    <mat-label>Partitions</mat-label>
                    <input matInput (change)="getPartitionNum($event.target.value)" placeholder="5">
                </mat-form-field>
            </div>

            <i class="fas fa-search fa-2x" (click)="onClickSearchButton()"></i>

        </div>
        <!--agent selection for log anpopContentd logSeries conditions -->
        <div *ngIf="currState ==='log' || currState ==='logSeries'" class= "d-flex align-content-end">
            <div class="agent-title ml-5">agents</div>
            <div class="agents">
                <div class="d-flex flex-wrap">
                    <div *ngFor="let id of selectedID" class="agent-selected" (click)="onDeleteID(id)" [ngValue]="id" >
                        <p>agent {{id}} </p>
                        <div class="hidden"><i class="fas fa-trash"></i></div>
                    </div>
                    <div *ngIf="selectedID.length<9" class="more col-lg-1" (click)="openLg(content)">+ </div>
                </div>
            </div>  
        </div>
            
        <ng-template #popContent > 
            <div class="default-fontsize" *ngFor="let content of popoverContent">
                {{content}}
            </div>
        </ng-template>

        <svg *ngIf="currState==='log'" [attr.width]="width" [attr.height]="height">
            <marker id="arrow" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="4" markerHeight="4" orient="auto">
                    <path fill="var(--secondary)" d="M0,-5L10,0L0,5"></path>
                </marker>
            <rect class="agentBox" *ngFor="let box of agentBox" [attr.x]="box.x" [attr.y]="box.y" [attr.width]="boxWidth" [attr.height]="boxHeight"></rect>
            <text font-size="2rem"  *ngFor="let text of texts, index as i" 
            class="agentbox-text"
            [attr.x]="text.x" 
            [attr.y]="text.y"
            [attr.fill]="white"> 
            Agent {{text.textID}} </text>
            <line stroke-dasharray="5, 5" class="vertical" *ngFor="let line of timeline" [attr.x1]="line.x1" [attr.y1]="line.y1" [attr.x2]="line.x2" [attr.y2]="height"/>     
            <line stroke="var(--secondary)" stroke-width="4" *ngFor="let line of communications" [class.hidden]="line.hidden" [attr.x1]="line.x1" [attr.y1]="line.y1" [attr.x2]="line.x2" [attr.y2]="line.y2" marker-end="url(#arrow)"/> 
            <rect class="logBox" *ngFor="let box of logBoxes, index as i" 
                [class.hidden]="box.hidden" 
                (mouseenter)="onChangePopoverContent(i)" 
                triggers="mouseenter:mouseleave" 
                [ngbPopover]="popContent" 
                placement="right" 
                container="body" 
                [attr.x]="box.x" 
                [attr.y]="box.y" 
                [attr.width]="logBoxWidth" 
                [attr.height]="logBoxHeight"
                [ngClass]="box.topic"
            ></rect>    
        </svg> 

        <div *ngIf="currState==='log'" class="topics d-flex-column">
            <div class="topic-title"> Topic </div>
            <div [class.selected]="isTopicSelected[0]" class="error-tag tag mb-3" (click)="onToggleTopic(0)">error</div>
            <div [class.selected]="isTopicSelected[1]" class="debug-tag tag mb-3" (click)="onToggleTopic(1)" >debug</div>
            <div [class.selected]="isTopicSelected[2]"class="msg-tag tag mb-3" (click)="onToggleTopic(2)">msg</div>
            <div [class.selected]="isTopicSelected[3]" class="status-tag tag mb-3" (click)="onToggleTopic(3)">status</div>
            <div [class.selected]="isTopicSelected[4]" class="app-tag tag mb-3" (click)="onToggleTopic(4)">app</div>
            <div [class.selected]="isTopicSelected[5]" class="beh-tag tag" (click)="onToggleTopic(5)">beh</div>
        </div> 
        
 

        <div *ngIf="currState==='logSeries'" class="log-series-graph">
            <ngx-charts-bubble-chart *ngIf="selectedID.length !== 0"
                [view]="viewBubble"
                [scheme]="colorScheme"
                [results]="bubbleData"
                xAxis="true"
                yAxis="true"     
                legend="true"
                showXAxisLabel="true"
                showYAxisLabel="true"
                xAxisLabel="time"
                [xAxisTicks]="xAxisTicks"
                [xAxisTickFormatting]="xAxisTickFormatting"
                [rotateXAxisTicks]="true"
                yAxisLabel="value"
                [minRadius]="minRadius"
                [maxRadius]="maxRadius"
                [trimXAxisTicks]="false"
                (select)="onSelect($event)"
                (activate)="onActivate($event)"
                (deactivate)="onDeactivate($event)">
                <ng-template #tooltipTemplate let-model="model">
                    <div class="tt">
                        <div>{{model.name}}</div>  
                        <div>Value: {{model.y}}</div>
                    </div>   
                </ng-template>
            </ngx-charts-bubble-chart>
        </div>


        <ng-template #popFrequency class="heatmap-popover" > 
            <div class="default-fontsize"> Agent Send: {{ popoverFrequency.x }} </div>
            <div class="default-fontsize"> Agent Receive : {{ popoverFrequency.y }} </div>
            <div class="default-fontsize"> Msg Count :{{ popoverFrequency.value }} </div>
        </ng-template>


        <div  *ngIf="currState==='statistics'">
        <div class="row justify-content-around" >
            <div *ngIf="statsInfo !== null" class="col-sm-5">
                <table class="table table-hover default-fontsize">
                    <thead>
                        <tr>
                        <th scope="col">#</th>
                        <th scope="col">Start</th>
                        <th scope="col">End</th>
                        <th scope="col">Duration</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of statsInfo.list | paginate: { itemsPerPage: 10, currentPage: q }; index as i ">
                            <th scope="row">{{ (q - 1) * 10 + i + 1 }}</th>
                            <td>{{item.start.split(".")[0]}}</td>
                            <td>{{item.end.split(".")[0]}}</td>
                            <td>{{convertSecond(item.duration)}}</td>
                        </tr>
                    </tbody>
                </table>
                <pagination-controls class="pagination justify-content-end" (pageChange)="q = $event"></pagination-controls>
            </div>
            <div *ngIf="statsInfo !== null" class="col-sm-4">
            <div class="row justify-content-around stats-dashboard">
                <div class="card col-sm-5">
                    <div class="card-body">
                    <h1 class="card-title">max</h1>
                    <p class="card-text">{{convertSecond(statsInfo.max)}}</p>
                    </div>
                </div>
                <div class="card col-sm-5">
                    <div class="card-body">
                    <h1 class="card-title">min</h1>
                    <p class="card-text">{{convertSecond(statsInfo.min)}}</p>
                    </div>
                </div>
                <div class="card col-sm-5">
                    <div class="card-body">
                    <h1 class="card-title">count</h1>
                    <p class="card-text">{{statsInfo.count}}</p>
                    </div>
                </div>
                <div class="card col-sm-5">
                    <div class="card-body">
                    <h1 class="card-title">average</h1>
                    <p class="card-text">{{convertSecond(statsInfo.average)}}</p>
                    </div>
                </div>
            </div>
            </div>             
        </div>
        </div>

        <div *ngIf="currState==='heatmap'" class="d-flex justify-content-center">

        <svg class="heatmap" width="1000" height="800" >
            <rect class="grid" *ngFor="let grid of grids, index as i" 
            [attr.fill]="grid.color" 
            [attr.x]="grid.x * gridWidth" 
            [attr.y]="grid.y * gridWidth" 
            [attr.width]="gridWidth" 
            [attr.height]="gridWidth"
            (mouseenter)="onEnterGrid(i)" 
            (mouseleave)="onLeaveGrid(i)" 
            triggers="mouseenter:mouseleave" 
            [ngbPopover]="popFrequency"
            placement="top" 
            container="body"
            ></rect>

            
            <rect *ngFor="let legend of colorPartitionEle, index as i"
                [attr.x] = "700"
                [attr.y]= "(legendWidth + 10) * i + 50"
                [attr.width]="legendWidth"
                [attr.height]="legendWidth"
                [attr.fill]="legend"
            ></rect>

            <text *ngFor="let text of colorLegendTexts, index as i"
            [attr.x] = "750"
            [attr.y]= "(legendWidth + 10) * i + 70"
            [attr.fill]="gray"
            > {{text}}</text>


<!--                 <text class="xlabel" x="350" y="730"> agent ID of sender</text>
            <text class="ylabel" x="-10" y="350"> agent ID of receiver</text> -->
        </svg>





        
        </div>
        

    </div>
</div>
   



