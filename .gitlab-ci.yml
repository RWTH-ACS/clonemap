stages:
  - build
  - test
  - deploy

amsbuild:
  stage: build
  script:
    - export GOPATH=$HOME/go
    - docker build -f build/docker/ams/Dockerfile -t ams .

agencybuild:
  stage: build
  script:
    - export GOPATH=$HOME/go
    - docker build -f build/docker/agency/Dockerfile -t agency .

benchmarkbuild:
  stage: build
  script:
    - export GOPATH=$HOME/go
    - docker build -f build/docker/benchmark/Dockerfile -t benchmark .

loggerbuild:
  stage: build
  script:
    - export GOPATH=$HOME/go
    - docker build -f build/docker/logger/Dockerfile -t logger .

dfbuild:
  stage: build
  script:
    - export GOPATH=$HOME/go
    - docker build -f build/docker/df/Dockerfile -t df .

pnpbuild:
  stage: build
  script:
    - export GOPATH=$HOME/go
    - docker build -f build/docker/plugnplay/Dockerfile -t plugnplay .

stubbuild:
  stage: build
  script:
    - export GOPATH=$HOME/go
    - cd cmd/kubestub
    - CGO_ENABLED=0 GOOS=linux go build main.go

# amstest:
#   stage: test
#   only:
#     - master
#   script:
#     - cd pkg/ams
#     - CGO_ENABLED=0 go test -coverpkg=./...

agencytest:
  stage: test
  script:
    - cd pkg/agency
    - CGO_ENABLED=0 go test -coverpkg=./...

loggertest:
  stage: test
  script:
    - cd pkg/logger
    - CGO_ENABLED=0 go test -coverpkg=./...

amsdeploy:
  stage: deploy
  only:
    - master
    - develop
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.git.rwth-aachen.de
    - docker tag ams registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/ams
    - docker push registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/ams

agencydeploy:
  stage: deploy
  only:
    - master
    - develop
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.git.rwth-aachen.de
    - docker tag agency registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/agency
    - docker push registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/agency

benchmarkdeploy:
  stage: deploy
  only:
    - master
    - develop
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.git.rwth-aachen.de
    - docker tag benchmark registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/benchmark
    - docker push registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/benchmark

loggerdeploy:
  stage: deploy
  only:
    - master
    - develop
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.git.rwth-aachen.de
    - docker tag logger registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/logger
    - docker push registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/logger

dfdeploy:
  stage: deploy
  only:
    - master
    - develop
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.git.rwth-aachen.de
    - docker tag df registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/df
    - docker push registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/df

pnpdeploy:
  stage: deploy
  only:
    - master
    - develop
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.git.rwth-aachen.de
    - docker tag plugnplay registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/plugnplay
    - docker push registry.git.rwth-aachen.de/acs/public/cloud/mas/clonemap/plugnplay
